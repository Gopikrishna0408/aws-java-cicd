name: Java AWS CI/CD Pipeline (OIDC)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Java
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3️⃣ Build Java application
      - name: Build Java application
        run: |
          cd app
          mvn clean package
          ls -l target
          cp target/demo-0.0.1-SNAPSHOT.jar demo-0.0.1-SNAPSHOT.jar

      # 4️⃣ Configure AWS credentials using OIDC
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::515966497293:role/GitHubActionsJavaCICDRole
          aws-region: us-east-1

      # 5️⃣ Create S3 bucket if it does not exist
      - name: Create S3 bucket
        run: |
          aws s3 mb s3://java-cicd-artifacts-dev || true

      # 6️⃣ Upload JAR to S3
      - name: Upload application JAR to S3
        run: |
          aws s3 cp app/demo-0.0.1-SNAPSHOT.jar \
            s3://java-cicd-artifacts-dev/demo-0.0.1-SNAPSHOT.jar

      # 7️⃣ Deploy CloudFormation stack
      - name: Deploy CloudFormation stack
        run: |
          aws cloudformation deploy \
            --template-file infra/template.yaml \
            --stack-name java-cicd-dev \
            --parameter-overrides file://infra/params-dev.json \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
